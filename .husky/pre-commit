#!/bin/bash

# Run beads sync if available (optional - contributors may not have bd)
if command -v bd >/dev/null 2>&1; then
  bd hook pre-commit "$@" 2>/dev/null || true
fi

# Format staged .ts/.js files with prettier
npx lint-staged

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check if src/ files changed
SRC_CHANGED=$(echo "$STAGED_FILES" | grep -E "^src/" || true)

# Check if TypeScript/JavaScript files changed
TS_FILES=$(echo "$STAGED_FILES" | grep -E "\.(ts|tsx|js|jsx)$" || true)

# Determine what needs to run
RUN_TESTS=""
RUN_TYPECHECK=""

if [ -n "$SRC_CHANGED" ]; then
  RUN_TESTS=1
else
  echo "‚è≠Ô∏è  No src/ changes, skipping tests"
fi

if [ -n "$TS_FILES" ]; then
  RUN_TYPECHECK=1
else
  echo "‚è≠Ô∏è  No TypeScript changes, skipping type check"
fi

# Run tests and type-check in parallel when both are needed
if [ -n "$RUN_TESTS" ] && [ -n "$RUN_TYPECHECK" ]; then
  echo "üì¶ Running tests and type-check in parallel..."

  npm test -- --run &
  TEST_PID=$!

  npm run type-check &
  TYPECHECK_PID=$!

  TEST_EXIT=0
  TYPECHECK_EXIT=0

  wait $TEST_PID || TEST_EXIT=$?
  wait $TYPECHECK_PID || TYPECHECK_EXIT=$?

  if [ $TEST_EXIT -ne 0 ]; then
    echo "‚ùå Tests failed"
  fi
  if [ $TYPECHECK_EXIT -ne 0 ]; then
    echo "‚ùå Type check failed"
  fi
  if [ $TEST_EXIT -ne 0 ] || [ $TYPECHECK_EXIT -ne 0 ]; then
    exit 1
  fi

  # Coverage check (optional, set CHECK_COVERAGE=1 to enable)
  if [ "$CHECK_COVERAGE" = "1" ]; then
    .claude/hooks/check-coverage.sh
  fi

elif [ -n "$RUN_TESTS" ]; then
  echo "üì¶ src/ changed, running tests..."
  npm test -- --run

  if [ "$CHECK_COVERAGE" = "1" ]; then
    .claude/hooks/check-coverage.sh
  fi

elif [ -n "$RUN_TYPECHECK" ]; then
  echo "üîç TypeScript files changed, running type check..."
  npm run type-check
fi
