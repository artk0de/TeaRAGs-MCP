#!/bin/bash

# Run beads sync if available (optional - contributors may not have bd)
if command -v bd >/dev/null 2>&1; then
  bd hook pre-commit "$@" 2>/dev/null || true
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check if src/ files changed
SRC_CHANGED=$(echo "$STAGED_FILES" | grep -E "^src/" || true)

# Check if TypeScript/JavaScript files changed
TS_FILES=$(echo "$STAGED_FILES" | grep -E "\.(ts|tsx|js|jsx)$" || true)

# Run tests only if src/ changed
if [ -n "$SRC_CHANGED" ]; then
  echo "üì¶ src/ changed, running tests..."
  npm test -- --run

  # Coverage check (optional, set CHECK_COVERAGE=1 to enable)
  if [ "$CHECK_COVERAGE" = "1" ]; then
    .claude/hooks/check-coverage.sh
  fi
else
  echo "‚è≠Ô∏è  No src/ changes, skipping tests"
fi

# Type check only if TS files changed
if [ -n "$TS_FILES" ]; then
  echo "üîç TypeScript files changed, running type check..."
  npm run type-check
else
  echo "‚è≠Ô∏è  No TypeScript changes, skipping type check"
fi
