#!/bin/bash

# Run beads sync if available (optional - contributors may not have bd)
if command -v bd >/dev/null 2>&1; then
  bd hook pre-commit "$@" 2>/dev/null || true
fi

# Format and lint staged .ts/.js files
if ! npx lint-staged 2>&1; then
  echo ""
  echo "============================================"
  echo "  lint-staged failed (ESLint or Prettier)"
  echo "============================================"
  echo ""
  echo "If ESLint --fix could not auto-fix the issue:"
  echo "  1. Read the error message above"
  echo "  2. Fix the code manually (do NOT change eslint.config.js)"
  echo "  3. Stage the fix: git add <file>"
  echo "  4. Retry the commit"
  echo ""
  echo "Common fixes:"
  echo "  - no-floating-promises  ‚Üí add 'await' or 'void' before the promise"
  echo "  - no-unused-vars        ‚Üí remove the unused variable/import"
  echo "  - eqeqeq                ‚Üí use === instead of =="
  echo "  - consistent-type-imports ‚Üí add 'type' keyword to type-only imports"
  echo ""
  exit 1
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# Check if src/ files changed
SRC_CHANGED=$(echo "$STAGED_FILES" | grep -E "^src/" || true)

# Check if TypeScript/JavaScript files changed
TS_FILES=$(echo "$STAGED_FILES" | grep -E "\.(ts|tsx|js|jsx)$" || true)

# Determine what needs to run
RUN_TESTS=""
RUN_TYPECHECK=""

if [ -n "$SRC_CHANGED" ]; then
  RUN_TESTS=1
else
  echo "‚è≠Ô∏è  No src/ changes, skipping tests"
fi

if [ -n "$TS_FILES" ]; then
  RUN_TYPECHECK=1
else
  echo "‚è≠Ô∏è  No TypeScript changes, skipping type check"
fi

# Run tests and type-check in parallel when both are needed
if [ -n "$RUN_TESTS" ] && [ -n "$RUN_TYPECHECK" ]; then
  echo "üì¶ Running tests and type-check in parallel..."

  npm test -- --run &
  TEST_PID=$!

  npm run type-check &
  TYPECHECK_PID=$!

  TEST_EXIT=0
  TYPECHECK_EXIT=0

  wait $TEST_PID || TEST_EXIT=$?
  wait $TYPECHECK_PID || TYPECHECK_EXIT=$?

  if [ $TEST_EXIT -ne 0 ]; then
    echo "‚ùå Tests failed"
  fi
  if [ $TYPECHECK_EXIT -ne 0 ]; then
    echo "‚ùå Type check failed"
  fi
  if [ $TEST_EXIT -ne 0 ] || [ $TYPECHECK_EXIT -ne 0 ]; then
    exit 1
  fi

  # Coverage check (optional, set CHECK_COVERAGE=1 to enable)
  if [ "$CHECK_COVERAGE" = "1" ]; then
    .claude/hooks/check-coverage.sh
  fi

elif [ -n "$RUN_TESTS" ]; then
  echo "üì¶ src/ changed, running tests..."
  npm test -- --run

  if [ "$CHECK_COVERAGE" = "1" ]; then
    .claude/hooks/check-coverage.sh
  fi

elif [ -n "$RUN_TYPECHECK" ]; then
  echo "üîç TypeScript files changed, running type check..."
  npm run type-check
fi
